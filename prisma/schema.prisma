// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(AUTHOR)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
  accounts      Account[]
  sessions      Session[]
  editorialBoardMembership EditorialBoardMember?
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  ADMIN
  AUTHOR
  REVIEWER
  EDITOR
}

// Content models
model Author {
  id          String   @id @default(cuid())
  name        String
  title       String?
  institution String?
  bio         String?
  email       String?  @unique
  orcid       String?  // ORCID identifier (e.g., 0000-0002-1825-0097)
  website     String?
  linkedin    String?
  twitter     String?
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  authoredContent ContentAuthor[]
}

model Content {
  id            String         @id @default(cuid())
  type          ContentType
  title         String
  slug          String         @unique
  description   String
  content       String
  publishedAt   DateTime
  updatedAt     DateTime       @updatedAt
  featured      Boolean        @default(false)
  status        ContentStatus  @default(DRAFT)

  // View/Impression tracking
  viewCount     Int            @default(0) // Number of unique views/impressions

  // PDF file storage
  pdfUrl        String?        // URL to the uploaded PDF file
  pdfFileName   String?        // Original filename of the uploaded PDF

  // Citation tracking
  doi              String?        // Digital Object Identifier
  crossrefStatus   CrossrefStatus? // Crossref registration status
  crossrefDepositId String?       // Crossref deposit ID for tracking
  citationCount    Int            @default(0) // Number of times cited
  citationStyle    String?        // Preferred citation style (APA, MLA, Chicago, etc.)
  bibtex           String?        // BibTeX citation format

  // Author relationship (many-to-many through ContentAuthor)
  authors       ContentAuthor[]

  // Type-specific fields stored as JSON
  metadata      Json?

  // Tags (many-to-many)
  tags          ContentTag[]
  
  // Journal relationship (optional - content can be published in a journal)
  journalId     String?
  journal       Journal?  @relation(fields: [journalId], references: [id], onDelete: SetNull)

  createdAt     DateTime       @default(now())

  @@index([type, slug])
  @@index([publishedAt])
  @@index([doi])
}

// Junction table for Content-Author many-to-many relationship
model ContentAuthor {
  id        String   @id @default(cuid())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  contentId String
  author    Author   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String

  @@unique([contentId, authorId])
}

// Junction table for Content-Tag many-to-many relationship
model ContentTag {
  id        String   @id @default(cuid())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  contentId String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId     String

  @@unique([contentId, tagId])
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  content   ContentTag[]
  createdAt DateTime  @default(now())
}

enum ContentType {
  ARTICLE
  CASE_STUDY
  BOOK
  BOOK_CHAPTER
  TEACHING_NOTE
  COLLECTION
}

enum ContentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum CrossrefStatus {
  PENDING
  REGISTERED
  FAILED
}

// Editorial Board
model EditorialBoardMember {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  position   String?  // e.g., "Editor-in-Chief", "Associate Editor"
  department String?  // e.g., "Business School", "Economics Department"
  bio        String?  // Brief biography
  order      Int      @default(0) // Display order (lower numbers appear first)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Journal {
  id          String        @id @default(cuid())
  title       String
  slug        String        @unique
  description String?
  issn        String?       // International Standard Serial Number
  eissn       String?       // Electronic ISSN
  publisher   String?       // Publisher name
  frequency   String?       // e.g., "Monthly", "Quarterly", "Bi-annual"
  language    String?       // e.g., "English", "Multi-lingual"
  openAccess  Boolean       @default(false)
  impactFactor String?      // Journal Impact Factor
  coverImage  String?       // URL to cover image
  website     String?       // Journal website URL
  submissionGuidelines String? // Submission guidelines in markdown/HTML
  scope       String?       // Journal scope and aims
  indexedIn   String?       // Where the journal is indexed (e.g., "Scopus, Web of Science")
  status      JournalStatus @default(DRAFT)
  featured    Boolean       @default(false)
  order       Int           @default(0) // For custom ordering
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  content     Content[]     // Content published in this journal
}

enum JournalStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}
